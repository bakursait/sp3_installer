#!/bin/bash

# Export Variables:
MAIN_DIRECTORY_LOCATION="$(cd "$(dirname "$0")" && pwd)"
source "$MAIN_DIRECTORY_LOCATION/script_variables.sh"


# Ensure non-interactive mode for apt
export DEBIAN_FRONTEND=noninteractive

#ensure the current user has the full 
echo "$USER ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/$USER


usage(){
    echo "Usage: $0 {devstack|shibsp}"
    echo "You must specify at least one option to run the script."
    exit 1
}


# Setup Devstack:
#source "$MAIN_DIRECTORY_LOCATION/setup_devstack.sh"


setup_devstack() {
    # Step 1: Add stack user
    if ! id -u $STACK_USER >/dev/null 2>&1; then
	echo "Adding stack user..."
	sudo useradd -s /bin/bash -d $DEVSTACK_HOME -m $STACK_USER
    else
	echo "User ${STACK_USER} already exists."
    fi
    
    
    # Step 2: Set the stack user's home directory executable by ALL
    echo "Setting home directory permissions for $STACK_USER..."
    sudo  chmod a+x $DEVSTACK_HOME
    
    # Step 3: Give stack user sudo privileges
    if [ ! -f /etc/sudoers.d/$STACK_USER ]; then
	echo "Granting sudo privileges to $STACK_USER..."
	echo "$STACK_USER ALL=(ALL) NOPASSWD: ALL" | sudo  tee /etc/sudoers.d/$STACK_USER
	#    sudo chmod 0440 /etc/sudoers.d/$STACK_USER
    else
	echo "Sudo privileges for $STACK_USER already set."
    fi
    
    # Step 4: Switch to stack user and execute the following as stack
    echo "Switching to $STACK_USER and setting up DevStack..."
    sudo -u $STACK_USER bash <<EOF
cd $DEVSTACK_HOME

# Step 5: Clone DevStack repository
if [ ! -d devstack ]; then
    echo "Cloning DevStack repository..."
    git clone https://opendev.org/openstack/devstack -b $DEVSTACK_BRANCH
else
    echo "DevStack repository already cloned."
fi

# Step 6: Access the DevStack directory
cd devstack

# Step 7: Copy sample local.conf
echo "Setting up local.conf..."
cp samples/local.conf .


# Step 8: Configure local.conf
sed -i 's/^ADMIN_PASSWORD=.*/ADMIN_PASSWORD=$ADMIN_PASSWORD/' local.conf
sed -i 's/^DATABASE_PASSWORD=.*/DATABASE_PASSWORD=\$ADMIN_PASSWORD/' local.conf
sed -i 's/^RABBIT_PASSWORD=.*/RABBIT_PASSWORD=\$ADMIN_PASSWORD/' local.conf
sed -i 's/^SERVICE_PASSWORD=.*/SERVICE_PASSWORD=\$ADMIN_PASSWORD/' local.conf
sed -i 's/^#HOST_IP=.*/HOST_IP=$HOST_IP/' local.conf
sed -i 's/^HOST_IP=.*/HOST_IP=$HOST_IP/g' local.conf


# Step 9: Install DevStack
echo "Starting DevStack installation. This might take some time..."
./stack.sh || { echo "DevStack installation failed"; exit 1; }
EOF

    # Step 10: Test Accessing Horizon
    echo "DevStack installation complete!"
    echo "You can access the Horizon dashboard at: http://$HOST_IP/dashboard"
}




# Function to set up Shibboleth SP
#source "$MAIN_DIRECTORY_LOCATION/setup_shib_sp.sh"
setup_shib_sp() {
    echo "Starting Shibboleth SP setup..."
    # Add your Shibboleth SP setup steps here
    echo "Shibboleth SP setup complete!"
}


if [[ $# -eq 0 ]]; then
    usage
fi

# Execute the requested functions:
for option in "$@"; do
    case $option in
	devstack)
	#setup_devstack
	#usage
	    ;;
	shibsp)
	    setup_shib_sp
	    ;;
	*)
	    echo "Invalid option: $option"
	    usage
	    ;;
    esac
done

